# SmartVoice 技术总体设计

**版本:** 2.0
**日期:** 2026-01-22
**状态:** 已确认

---

## 📋 文档概述

本文档从产品需求到技术实现建立整体视角，梳理核心业务流程、技术实现路径、关键技术挑战，为后续详细技术设计奠定基础。

**技术约束条件:**
- 团队技术栈：React + Node.js
- 开发预算：¥2,524/年(MVP 100项目) - 自部署优先策略
- 目标并发：500-1000用户
- 开发周期：3-6个月(分阶段)
- 团队规模：2人兼职
- GPU资源：阿里云ECS Tesla T4 GPU(Coqui TTS推理)

---

## 🎯 产品核心流程

### 流程 1: 文本上传到角色识别

**业务描述:**
用户上传小说/剧本文本文件（txt格式），系统自动解析文本结构，识别章节、段落、对话和旁白，并使用AI技术自动识别角色、分配音色。

**流程图:**
```
用户选择文件 → 文件上传 → 格式验证 → 文本解析 →
  → 章节识别 → 角色识别 → 对话归属 → 音色自动分配 → 展示结果
```

**关键节点:**

1. **节点1: 文件上传**
   - 用户操作: 拖拽或选择txt文件上传(≤10MB)
   - 系统响应: 前端验证格式和大小,上传到MinIO(自部署对象存储),返回文件URL
   - 预期结果: 文件成功上传,用户看到上传进度和成功提示

2. **节点2: 文本解析**
   - 用户操作: 等待系统自动处理
   - 系统响应: 后端解析txt文本，识别章节结构（基于标题、空行）、分割段落、标记对话
   - 预期结果: 结构化的文本数据，章节列表显示在前端

3. **节点3: 角色识别**
   - 用户操作: 查看识别结果
   - 系统响应: 使用Deepseek API识别说话者,聚类角色实体,推断性别,判断重要性
   - 预期结果: 角色列表(名称、性别、对话数量、重要性)

4. **节点4: 音色分配**
   - 用户操作: 预览默认音色，可手动调整
   - 系统响应: 根据性别和重要性自动分配音色（男声/女声/旁白）
   - 预期结果: 每个角色都有对应的音色配置

**技术实现映射:**

| 业务节点 | 技术组件 | 技术能力 | 数据流 |
|---------|---------|---------|--------|
| 文件上传 | React前端 + MinIO | 文件选择、拖拽、上传进度 | 文件 → MinIO → URL返回前端 |
| 格式验证 | 前端 + 后端 | 文件类型检查、大小限制 | 文件元数据 → 验证逻辑 |
| 文本解析 | Node.js后端 | txt解析、章节识别、段落分割 | MinIO文件 → 结构化JSON |
| 角色识别 | Deepseek API(NLP) | 实体识别、对话归属、性别推断 | 文本段落 → Deepseek API → 角色列表 |
| 音色分配 | 后端业务逻辑 | 性别匹配、区分度算法 | 角色数据 → 音色配置 |
| 数据存储 | PostgreSQL | 项目、章节、角色、配置存储 | 结构化数据 → 数据库 |

**性能要求:**
- 文件上传：< 5秒（1MB文件）
- 文本解析：< 10秒（10万字）
- 角色识别：< 30秒（10万字）
- 识别准确率：> 85%

---

### 流程 2: 音色配置和预览

**业务描述:**
用户查看AI自动分配的音色，可以试听预览效果，调整音色、音速、音调、情绪等参数，直到满意。

**流程图:**
```
查看角色列表 → 选择角色 → 查看默认音色 → 点击预览 →
  → 选择预览文本 → TTS生成 → 试听音频 → 调整参数 →
  → 再次预览 → 满意后保存配置
```

**关键节点:**

1. **节点1: 音色预览**
   - 用户操作: 点击"预览音色"按钮
   - 系统响应: 选择该角色的一段对话(50-100字),调用Coqui TTS生成音频(失败时自动切换百度TTS)
   - 预期结果: 3秒内返回音频,前端播放器播放

2. **节点2: 参数调整**
   - 用户操作: 拖动滑块调整音速（0.5x-2.0x）、音调（-3到+3）、选择情绪（中性/开朗/严肃）
   - 系统响应: 实时更新配置，支持快速重新生成预览
   - 预期结果: 参数变化立即反映，用户可A/B对比

3. **节点3: 保存配置**
   - 用户操作: 点击"保存配置"
   - 系统响应: 将音色配置存入数据库，关联到角色
   - 预期结果: 配置持久化，后续生成使用该配置

**技术实现映射:**

| 业务节点 | 技术组件 | 技术能力 | 数据流 |
|---------|---------|---------|--------|
| 音色列表 | React前端 | 音色库展示、筛选(男声/女声) | 音色库数据 → UI组件 |
| 预览文本选择 | 后端逻辑 | 从角色对话中智能选取代表性文本 | 角色对话 → 预览文本(50-100字) |
| TTS调用 | Node.js + Coqui TTS Adapter | Coqui TTS(主),百度TTS(备用),自动Fallback | 文本+配置 → TTS Adapter → 音频URL |
| 音频播放 | React音频播放器 | 在线播放、进度控制 | MinIO音频URL → HTML5 Audio |
| 配置存储 | PostgreSQL | 角色音色配置表 | 配置对象 → JSON存储 |

**性能要求:**
- 预览生成：< 3秒（100字）
- 音频缓存：相同文本+配置复用缓存
- 并发支持：100+用户同时预览

---

### 流程 3: 批量音频生成

**业务描述:**
用户确认所有角色的音色配置后，选择要生成的章节（可批量），系统异步处理，按章节顺序调用TTS生成每个角色的对话和旁白，拼接成完整章节音频。

**流程图:**
```
选择章节（支持多选） → 点击"开始生成" → 创建生成任务 →
  → Worker异步处理 → 逐段落调用TTS → 音频拼接 →
  → 上传OSS → 更新任务状态 → WebSocket通知用户 → 生成完成
```

**关键节点:**

1. **节点1: 创建生成任务**
   - 用户操作: 选择章节，点击"批量生成"
   - 系统响应: 创建异步任务，加入任务队列，返回任务ID
   - 预期结果: 用户看到任务已创建，进入进度页面

2. **节点2: 异步TTS处理**
   - 用户操作: 查看实时进度
   - 系统响应: Worker从队列取任务，读取章节内容，按段落调用TTS API，根据角色ID应用对应音色
   - 预期结果: 生成数百个音频片段

3. **节点3: 音频拼接**
   - 用户操作: 等待处理
   - 系统响应: 使用ffmpeg按顺序拼接音频片段，生成完整章节音频文件
   - 预期结果: 单个MP3文件（章节名.mp3）

4. **节点4: 进度通知**
   - 用户操作: 实时查看进度
   - 系统响应: WebSocket推送进度（当前章节、完成百分比、预计剩余时间）
   - 预期结果: 前端进度条实时更新

**技术实现映射:**

| 业务节点 | 技术组件 | 技术能力 | 数据流 |
|---------|---------|---------|--------|
| 任务创建 | Node.js API | 任务入库、队列推送 | 章节列表 → Task表 → Redis Queue |
| 任务队列 | Redis + Bull | 任务调度、优先级、重试 | 任务对象 → Queue → Worker |
| Worker处理 | Node.js Worker | 异步处理、并发控制 | Queue → Worker → TTS API |
| TTS批量调用 | TTS API | 高并发调用、成本控制 | 段落文本 → API → 音频片段 |
| 音频拼接 | ffmpeg | 音频合并、格式转换 | 音频片段数组 → ffmpeg → 完整MP3 |
| 文件存储 | OSS | 大文件上传、CDN分发 | MP3文件 → OSS → CDN URL |
| 进度推送 | WebSocket | 实时双向通信 | Worker状态 → WebSocket → 前端 |

**性能要求:**
- 生成速度：约1分钟/万字
- 并发任务：支持10个任务同时处理
- 队列容量：1000个任务
- 成功率：> 95%（含重试）

---

### 流程 4: 音频预览和导出

**业务描述:**
用户查看已生成的音频列表，可在线试听，满意后下载单个或批量章节音频文件。

**流程图:**
```
查看项目音频列表 → 选择章节 → 点击播放 → 在线试听 →
  → 满意后点击下载 → 生成临时下载链接 → 浏览器下载文件
```

**关键节点:**

1. **节点1: 音频列表**
   - 用户操作: 进入项目详情页
   - 系统响应: 查询该项目的所有已生成音频，显示章节列表、时长、生成时间
   - 预期结果: 清晰的音频列表，支持筛选和排序

2. **节点2: 在线播放**
   - 用户操作: 点击播放按钮
   - 系统响应: 前端播放器加载OSS音频URL（CDN加速），支持进度拖动、倍速播放
   - 预期结果: 流畅播放，无卡顿

3. **节点3: 文件下载**
   - 用户操作: 点击"下载"按钮
   - 系统响应: 生成带签名的临时下载链接（有效期7天），浏览器触发下载
   - 预期结果: 文件下载到本地，文件名为"项目名-章节名.mp3"

**技术实现映射:**

| 业务节点 | 技术组件 | 技术能力 | 数据流 |
|---------|---------|---------|--------|
| 音频列表 | React前端 + API | 列表展示、分页、搜索 | 数据库查询 → JSON → UI |
| 在线播放 | HTML5 Audio + CDN | 流式播放、进度控制 | CDN URL → Audio元素 |
| 下载链接生成 | Node.js + OSS SDK | 签名URL生成 | 文件路径 → OSS签名 → 临时URL |
| 文件下载 | 浏览器 | 触发下载、进度显示 | 临时URL → 浏览器下载 |

**性能要求:**
- 播放加载：< 2秒
- 下载速度：取决于用户网络和CDN
- 链接有效期：7天（节省存储成本）

---

## 🔗 技术全链路视图

### 端到端技术流程图

```
┌─────────────┐
│   用户端     │
│  (浏览器)    │
└──────┬──────┘
       │ HTTPS
       │
┌──────▼──────┐
│     CDN     │ (静态资源、音频文件)
└──────┬──────┘
       │
┌──────▼────────────────────────┐
│      React 前端应用            │
│  ┌────────┬────────┬────────┐ │
│  │上传UI  │配置UI  │播放UI  │ │
│  └────────┴────────┴────────┘ │
└──────┬────────────────────────┘
       │ REST API / WebSocket
       │
┌──────▼────────────────────────┐
│      Node.js API层             │
│  认证、路由、限流              │
└──────┬────────────────────────┘
       │
┌──────▼────────────────────────┐
│     业务逻辑层                 │
│  ┌────────┬─────────┬───────┐ │
│  │文件服务│解析服务 │TTS服务│ │
│  └────────┴─────────┴───────┘ │
└──────┬────────────────────────┘
       │
┌──────▼────────────────────────┐
│        数据层                  │
│  ┌──────┬──────┬──────┬────┐  │
│  │MySQL │Redis │ OSS  │队列│  │
│  └──────┴──────┴──────┴────┘  │
└──────┬────────────────────────┘
       │
┌──────▼────────────────────────┐
│      第三方服务层              │
│  ┌──────┬──────┬──────┐      │
│  │TTS API│NLP  │云服务│      │
│  └──────┴──────┴──────┘      │
└───────────────────────────────┘
```

### 数据流向

**1. 文本上传流:**
```
用户 → 前端 → API → OSS存储 → 元数据入MySQL → 触发解析任务
```

**2. 解析和识别流:**
```
解析任务 → Worker读取OSS → 解析引擎 → 章节数据入MySQL →
  → NLP API调用 → 角色数据入MySQL → 音色自动分配
```

**3. TTS生成流:**
```
生成任务 → Redis Queue → Worker取任务 → 读取配置和文本 →
  → TTS API调用 → 音频片段 → ffmpeg拼接 → OSS上传 →
  → MySQL更新状态 → WebSocket通知前端
```

**4. 音频播放和下载流:**
```
前端请求 → API查询MySQL → 返回音频元数据 →
  → 前端加载CDN URL → 播放/下载
```

---

## 🚀 关键技术挑战

### 挑战 1: 角色识别准确率（目标 > 85%）

**问题描述:**
小说/剧本中角色识别是核心功能，需要准确识别说话者、区分不同角色、处理复杂对话场景（如群聊、没有明确标注的对话等）。

**影响范围:**
- 影响功能：智能角色识别、对话归属
- 用户体验：识别错误会导致音色分配混乱，用户需大量手动调整
- 核心价值：直接影响产品"智能"定位

**技术难点:**
1. 中文小说的对话格式多样（引号、冒号、"XX说"等）
2. 角色名称可能有别名、代称（如"他""她""小王"等）
3. 群聊场景下多人对话难以区分
4. 旁白和对话的界限模糊

**解决思路:**

**方案A: 使用大模型API（OpenAI GPT / 国产大模型）**
- 实现方式：Prompt Engineering，将文本发送给GPT API，要求识别角色和对话
- 优点：准确率高（可达90%+），无需训练，快速验证
- 缺点：成本高（约¥0.01/千字），API调用延迟，依赖外部服务
- 预估成本：单项目（30万字）约¥3

**方案B: 规则引擎 + 轻量NLP模型**
- 实现方式：基于正则表达式识别对话标记，使用BERT等轻量模型做实体识别和聚类
- 优点：成本低，速度快，可控性强
- 缺点：准确率较低（预计70-80%），需要大量规则调优
- 预估成本：几乎免费（仅服务器算力）

**推荐方案:** **方案A（MVP阶段）+ 方案B（成熟期）**
- MVP阶段使用GPT API快速验证，确保准确率达标
- 积累足够数据后，训练自己的模型替代，降低成本

**风险评估:**
- 技术风险：中（大模型API稳定性依赖厂商）
- 时间风险：低（API集成快）
- 成本风险：中（单用户成本可控，但规模化后需优化）

---

### 挑战 2: TTS生成速度和成本控制

**问题描述:**
批量生成大量音频(一部小说可能30万字,数百章节),需要控制生成速度和API成本,同时保证音质。

**影响范围:**
- 影响功能:批量章节生成
- 用户体验:生成时间过长用户会流失
- 商业模式:TTS成本是最大运营成本(自部署方案已解决)

**技术难点:**
1. 商业TTS API按字数计费,30万字小说成本约¥45-60
2. 串行调用速度慢(30万字需30-60分钟)
3. 并发调用受限于API QPS限制和成本
4. 音质和成本的平衡

**解决思路:**

**方案A: 自部署Coqui TTS + 高并发队列**
- 实现方式:
  - **部署开源Coqui TTS模型**(Tesla T4 GPU推理,2-5秒/千字)
  - 使用队列+多Worker并发生成(10个Worker并行)
  - Redis缓存已生成的音频片段(相同文本+音色+参数)
  - **自动Fallback机制** - Coqui TTS失败时自动切换百度TTS
- 优点:**边际成本¥0**,速度快(30万字约10-15分钟),完全可控
- 缺点:GPU固定成本¥2,160/年,音质略低于商业API(但可接受)
- 预估成本:单项目边际成本¥0(仅GPU摊销约¥20/项目 @ 100项目/年)

**方案B: 纯云TTS API(备用)**
- 实现方式:使用百度TTS API按需付费
- 优点:音质稳定,无运维成本
- 缺点:边际成本高(¥45/项目)
- 预估成本:100项目/年 = ¥4,500/年

**推荐方案:** **方案A为主 + 方案B自动Fallback**
- **MVP:** Coqui TTS(主要),百度TTS(备用),Adapter Pattern实现无缝切换
- **成本优势:** 100项目后即回本,1000项目节省¥41,500/年
- **风险控制:** Coqui TTS失败自动切换百度TTS,保证服务可用性

**风险评估:**
- 技术风险:中(Coqui TTS音质需测试,有百度TTS兜底)
- 时间风险:中(GPU部署需8h,Coqui TTS集成需16h)
- 成本风险:低(自部署后边际成本¥0,长期大幅节省)

---

### 挑战 3: 大文件处理性能（10万字文本 < 30秒）

**问题描述:**
用户上传的小说可能数十万字，需要快速解析、识别、处理，避免用户等待过久。

**影响范围:**
- 影响功能：文本解析、角色识别
- 用户体验：等待时间过长会导致用户流失
- 系统性能：大文本处理占用服务器资源

**技术难点:**
1. 大文本的内存占用和解析速度
2. NLP模型对长文本的处理能力
3. 数据库写入性能

**解决思路:**

**方案A: 分块处理 + 流式响应**
- 实现方式：
  - 将大文本分块（按章节或固定字数）
  - 异步处理，WebSocket流式返回结果
  - 数据库批量写入优化
- 优点：用户体验好（实时看到进度），服务器压力分散
- 缺点：需要WebSocket支持，前端复杂度增加
- 预估性能：10万字约20秒（分10块处理）

**方案B: 云函数并行处理**
- 实现方式：使用云函数（Serverless）并行处理不同章节
- 优点：高并发，按需付费
- 缺点：冷启动延迟，调试困难
- 预估性能：10万字约10-15秒

**推荐方案:** **方案A**
- 更可控，成本可预期，用户体验好

**风险评估:**
- 技术风险：低
- 时间风险：低
- 成本风险：低

---

### 挑战 4: 音频拼接质量和效率

**问题描述:**
需要将数百个TTS生成的音频片段按顺序拼接成完整章节音频，同时保证音质和拼接处的平滑过渡。

**影响范围:**
- 影响功能：批量章节生成
- 用户体验：拼接处有明显停顿或杂音会影响听感
- 系统性能：ffmpeg处理速度

**技术难点:**
1. 大量小文件的拼接效率
2. 拼接处的静音处理
3. 音频格式统一和编码参数

**解决思路:**

**方案A: ffmpeg批量拼接**
- 实现方式：
  - 所有片段使用相同格式（MP3, 24kHz, 64kbps）
  - 使用ffmpeg concat filter一次性拼接
  - 在对话间插入短暂静音（0.3-0.5秒）
- 优点：成熟稳定，音质好
- 缺点：大文件拼接耗时（数百个片段需数十秒）
- 预估性能：500个片段约30秒

**推荐方案:** **方案A**（唯一可行方案）

**风险评估:**
- 技术风险：低（ffmpeg成熟）
- 时间风险：低
- 成本风险：低

---

## 📏 技术边界和约束

### 团队能力边界

**当前团队:**
- 规模：2人兼职（全栈开发）
- 工作时间：每周约20小时/人（周末+晚上）
- 技术栈熟悉度：
  - 前端React: ⭐⭐⭐⭐⭐（非常熟练）
  - 后端Node.js: ⭐⭐⭐⭐⭐（非常熟练）
  - 数据库PostgreSQL: ⭐⭐⭐⭐（熟练）
  - AI/NLP: ⭐⭐（基础，会调用API）
  - 音视频处理: ⭐⭐（基础，会使用ffmpeg）
  - 运维DevOps: ⭐⭐⭐（基础Docker、云服务）

**技术短板:**
- 短板1：AI/NLP模型训练 - 应对方案：使用成熟API（OpenAI、百度、讯飞）
- 短板2：音视频编解码 - 应对方案：使用ffmpeg现成工具
- 短板3：大规模运维 - 应对方案：使用云服务托管（阿里云、腾讯云）

**技术优势:**
- 优势1：全栈能力强，快速迭代
- 优势2：React + Node.js技术栈统一，开发效率高
- 优势3：熟悉云服务，可快速搭建基础设施

---

### 预算和时间约束

**预算约束:**
- 总预算：¥1万（极低预算）
- 人力预算：¥0（兼职，无薪酬）
- 云服务预算：¥2,000/年（服务器、数据库、OSS）
- 第三方服务预算：¥5,000/年（TTS API、NLP API）
- 工具软件预算：¥500/年（开发工具、监控）
- 预留：¥2,500（应急）

**时间约束:**
- MVP开发周期：3个月（Alpha版）
- 每周投入：40人时（2人 × 20小时）
- 总投入：约480人时
- 关键里程碑：
  - 第2周：技术选型和架构设计完成
  - 第6周：后端核心功能完成
  - 第10周：前端开发完成
  - 第12周：联调测试和Alpha发布

**资源分配策略:**
- 核心P0功能：70%（角色识别、TTS生成、音频导出）
- 用户体验优化：20%（界面、交互、性能）
- 测试和修复：10%

---

### 性能和规模要求

**性能指标:**

| 指标 | MVP目标 | Beta目标 | V1.0目标 |
|------|---------|----------|----------|
| 并发用户数 | 100 | 500 | 1,000 |
| API响应时间(P95) | <1s | <500ms | <300ms |
| 文本解析速度 | 10万字/30秒 | 10万字/20秒 | 10万字/10秒 |
| 音频生成速度 | 1分钟/万字 | 30秒/万字 | 20秒/万字 |
| 系统可用性 | >99% | >99.5% | >99.9% |
| 角色识别准确率 | >85% | >90% | >95% |

**规模要求:**

| 维度 | MVP | Beta | V1.0 |
|------|-----|------|------|
| 注册用户 | 100 | 1,000 | 10,000 |
| 日活用户 | 20 | 200 | 1,000 |
| 数据存储 | 10GB | 100GB | 500GB |
| 音频文件存储 | 50GB | 500GB | 2TB |

---

### 合规和安全要求

**数据安全:**
- 用户密码：bcrypt加密存储
- 数据传输：HTTPS加密
- 敏感信息：脱敏处理（日志中不记录完整手机号、邮箱）

**隐私保护:**
- 用户协议和隐私政策
- 数据最小化收集（仅收集必要信息）
- 用户数据导出和删除功能（GDPR合规）

**内容合规:**
- 用户上传内容免责声明
- 版权提示（用户自行确保版权）
- 暂不做内容审核（MVP阶段）

**系统安全:**
- 防SQL注入：使用ORM（Prisma/TypeORM）
- 防XSS攻击：React自动转义
- API限流：每用户100次/分钟
- 日志审计：记录关键操作

---

## 🏗️ 技术分层策略

### 整体分层架构

```
┌─────────────────────────────────────┐
│        表现层 (Presentation)         │
│  - React Web前端                     │
│  - 响应式设计（支持移动Web）         │
│  - 静态资源CDN                       │
└──────────────┬──────────────────────┘
               │ HTTPS / REST API
┌──────────────▼──────────────────────┐
│         接口层 (API Gateway)         │
│  - Express路由                       │
│  - JWT认证                           │
│  - 请求限流（rate-limit）            │
│  - 日志中间件                        │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│        业务逻辑层 (Business)         │
│  ┌──────────┬──────────┬─────────┐  │
│  │用户服务  │项目服务  │TTS服务  │  │
│  ├──────────┼──────────┼─────────┤  │
│  │文件服务  │解析服务  │角色服务 │  │
│  └──────────┴──────────┴─────────┘  │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│       数据访问层 (Data Access)       │
│  - Prisma ORM                        │
│  - Redis Client                      │
│  - OSS SDK                           │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         数据存储层 (Storage)         │
│  ┌──────────┬──────────┬─────────┐  │
│  │PostgreSQL│  Redis   │  OSS    │  │
│  └──────────┴──────────┴─────────┘  │
└─────────────────────────────────────┘
               │
┌──────────────▼──────────────────────┐
│       第三方服务层 (External)        │
│  - TTS API (百度/讯飞)               │
│  - NLP API (GPT/BERT)                │
│  - 云服务 (阿里云/腾讯云)            │
└─────────────────────────────────────┘
```

### 各层职责

**表现层:**
- 用户交互和界面展示
- 前端状态管理（Zustand/Context）
- 前端路由（React Router）
- 表单验证
- **不包含业务逻辑**

**接口层:**
- API路由定义
- 请求参数验证
- JWT Token验证
- 限流保护
- 请求日志记录
- **不包含业务逻辑**

**业务逻辑层:**
- 核心业务规则
- 流程编排（如：上传→解析→识别→生成）
- 业务校验（如：用户配额检查）
- 第三方API调用封装
- 异步任务创建和管理

**数据访问层:**
- 数据库CRUD操作封装
- 缓存读写
- 事务管理
- **不包含业务逻辑**

**数据存储层:**
- 数据持久化
- 缓存存储
- 文件存储

**第三方服务层:**
- 外部API调用
- 云服务集成

---

### 层间交互规则

**原则:**
1. **单向依赖** - 上层依赖下层，下层不依赖上层
2. **职责单一** - 每层只负责特定职责
3. **接口清晰** - 层间通过明确的接口交互
4. **可替换性** - 下层实现可替换而不影响上层

**数据流向:**
```
用户请求 → 表现层 → 接口层 → 业务逻辑层 → 数据访问层 → 数据存储层
                                        ↓
                                   第三方服务层

用户响应 ← 表现层 ← 接口层 ← 业务逻辑层 ← 数据访问层 ← 数据存储层
```

---

## 🎯 技术选型初步方向

**注:** 详细技术选型对比在"模块1:技术栈选型"中完成。

### 初步倾向

**前端:**
- 框架：React 18
- 理由：团队熟悉度⭐⭐⭐⭐⭐，生态丰富，适合复杂交互
- 配套工具：
  - 状态管理：Zustand（轻量）
  - UI组件库：Ant Design（快速开发）
  - 构建工具：Vite（开发体验好）
  - 路由：React Router v6

**后端:**
- 语言：Node.js 18
- 框架：Express（简单）或Nest.js（规范）
- 理由：团队熟悉度⭐⭐⭐⭐⭐，JS全栈，npm生态丰富
- 配套工具：
  - ORM：Prisma（类型安全）
  - 任务队列：Bull + Redis
  - WebSocket：Socket.io

**数据库:**
- 主库:PostgreSQL 14(关系型,功能强大)
- 缓存:Redis 7(缓存、队列、Session)
- 对象存储:MinIO(自部署,S3兼容)
- 理由:数据结构清晰,需要复杂查询和事务,MinIO零边际成本

**第三方服务 vs 自部署:**
- **TTS(主):** Coqui TTS(自部署,GPU推理,边际成本¥0)
- **TTS(备):** 百度语音API(按需付费,¥0.15/千字)
- **NLP:** Deepseek API(最便宜,¥0.001/千token,比OpenAI便宜70%)
- **存储(主):** MinIO(自部署,零成本)
- **存储(备):** 阿里云OSS(异地备份,按需付费)
- **云服务:** 阿里云ECS(GPU支持Coqui TTS)

**架构模式:**
- Adapter Pattern:所有第三方服务统一接口,一行配置切换
- 自动Fallback:主服务失败自动切换备用服务

---

## 📊 技术可行性评估

### 整体可行性

| 维度 | 评估 | 说明 |
|------|------|------|
| 技术成熟度 | ⭐⭐⭐⭐⭐ | 使用成熟技术栈,无前沿技术 |
| 团队能力匹配 | ⭐⭐⭐⭐⭐ | React+Node.js团队完全熟悉 |
| 开发周期合理性 | ⭐⭐⭐⭐ | 3.75个月可行(自部署增加0.75个月) |
| 成本可控性 | ⭐⭐⭐⭐⭐ | MVP ¥2,524/年,远低于预算,长期大幅节省 |
| 风险可控性 | ⭐⭐⭐⭐ | 主要风险在Coqui TTS音质和GPU成本,有应对方案 |

### 关键风险

**高风险项:**
1. **Coqui TTS音质不达标** - 应对方案:预训练模型测试,自动Fallback到百度TTS,用户可选音质档位
2. **角色识别准确率不达标** - 应对方案:使用Deepseek API保证准确率,自动Fallback Qwen,允许用户手动调整

**中风险项:**
1. **GPU成本超预算** - 应对方案:按需实例(仅高峰期),抢占式实例(便宜60%),监控利用率
2. **开发周期延误** - 应对方案:简化MVP范围,使用AI辅助开发(GitHub Copilot)
3. **第三方API稳定性** - 应对方案:Adapter Pattern多厂商备选,重试机制,自动Fallback
4. **MinIO单点故障** - 应对方案:定期备份到OSS,健康检查,可恢复

**低风险项:**
1. **性能问题** - 应对方案：MVP用户量小，单服务器足够，后续可横向扩展
2. **安全问题** - 应对方案：使用成熟框架自带安全特性

---

## 🔗 相关文档

- [产品简介](../../01-product-design/SmartVoice/SmartVoice-brief.md)
- [功能规格](../../01-product-design/SmartVoice/features/feature-prioritization.md)
- [产品路线图](../../01-product-design/SmartVoice/roadmap/product-roadmap.md)
- [技术栈选型](tech-stack.md) - 下一步
- [系统架构设计](system-architecture.md) - 详细架构

---

## 📝 更新历史

| 版本 | 日期 | 变更说明 | 作者 |
|------|------|----------|------|
| 1.0  | 2026-01-21 | 初始版本,完成技术总体设计(纯云服务方案) | SmartVoice 团队 |
| 2.0  | 2026-01-22 | 重大更新:自部署优先策略(MinIO+Coqui TTS+Deepseek),Adapter Pattern,成本降至¥2,524/年(67%) | SmartVoice 团队 |

---

**技术决策确认:** 自部署优先+Adapter Pattern+自动Fallback,MVP成本¥2,524/年,长期节省67% ✅

**下一步:** 参考"技术栈选型"、"第三方服务评估"和"系统架构设计"了解详细实现方案。
